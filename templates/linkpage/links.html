<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Links</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">    </head>
    <body>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/vue@3"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


        <button></button>
        <h1>Links</h1>
        <section id="app">
            <form @submit.prevent="onSubmit" method="post" action="">
                <label for="link-name">Name:</label>
                <input v-model="linkName" type="text" id="link-name" required>
                <label for="link-url">URL:</label>
                <input v-model="linkURL" type="text" id="link-url" required>
                <label for="link-description">Description:</label>
                <input v-model="linkDescription" type="text" id="link-description">
                <button type="submit">Submit</button>
            </form>
            <form method="get" action="">
                <label for="link-search">Search:</label>
                <input v-model="searchText" type="text" id="link-search">
            </form>
            <br>
            <div id="form-alert" class="alert alert-danger d-none" role="alert">
                <span>[[ formError ]]</span>
            </div>
            <table class="table table-striped table-hover table-responsive float-start">
                <thead>
                    <tr>
                        <th scope="col">Link</th>
                        <th scope="col">Description</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="link in matchingLinks">
                        <td><a :href="link.URL">[[ link.Name ]]</a></td>
                        <td>[[ link.Description ]]</td>
                        <td><button type="button" class="btn-close" aria-label="Close"></button></td>
                    </tr>
                </tbody>
            </table>
        </section>

        {{ links | json_script:"all-links" }}

        {% csrf_token %}
        <script>
            const app = Vue.createApp({
                data() {
                    return {
                        searchText: '',
                        linkName: '',
                        linkURL: '',
                        linkDescription: '',
                        allLinks: JSON.parse(document.getElementById('all-links').textContent),
                        token: document.querySelector('[name=csrfmiddlewaretoken]').value,
                        formError: ''
                    }
                },
                computed: {
                    matchingLinks() {
                        result = [];
                        for (let link of this.allLinks) {
                            if (link['Name'].includes(this.searchText)) {
                                result.push(link);
                            }
                        }
                        return result;
                    }
                },
                methods: {
                    onSubmit() {
                        let alertElement = document.getElementById("form-alert");
                        alertElement.classList.add("d-none");
                        this.formError = "";
                        let newLink = {
                            'Name': this.linkName, 
                            'URL': this.linkURL, 
                            'Description': this.linkDescription
                        };
                        
                        let manageResponse = function(response) {
                            console.log(response);
                            if (response.data.code != 200) {
                                this.formError = response.data.message;
                                console.log(this.formError);
                                document.getElementById("form-alert").classList.remove("d-none");
                                this.allLinks = this.allLinks.filter((link) => link.Name !== newLink.Name);
                            }
                            else {
                                this.allLinks.push(newLink);
                            }
                        }

                        axios.post("{% url 'link-create' %}", newLink, {headers: {"X-CSRFToken": this.token, "content-type": "application/json"}})
                        .then(manageResponse.bind(this));
                    }
                }
            });
            app.config.compilerOptions.delimiters = ['[[', ']]'];
            app.mount('#app');
        </script>
    </body>
</html>
